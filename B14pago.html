<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B14 – Pago</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .method-card{cursor:pointer;border:2px solid transparent}
    .method-card.active{
      border-color:#198754;
      box-shadow:0 0 0 .25rem rgba(25,135,84,.25)
    }
    .alert-fixed{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:2000
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="row g-3">
    <!-- Métodos de pago -->
    <div class="col-lg-8">
      <div class="row g-3" id="metodos">
        <div class="col-sm-6 col-md-4">
          <div class="card method-card h-100" data-metodo="debito">
            <div class="card-body">
              <h5 class="card-title mb-1">Débito</h5>
              <p class="text-muted small mb-0">RedCompra / Maestro</p>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-md-4">
          <div class="card method-card h-100" data-metodo="credito">
            <div class="card-body">
              <h5 class="card-title mb-1">Crédito</h5>
              <p class="text-muted small mb-0">Visa / MasterCard / Amex</p>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-md-4">
          <div class="card method-card h-100" data-metodo="efectivo">
            <div class="card-body">
              <h5 class="card-title mb-1">Efectivo</h5>
              <p class="text-muted small mb-0">Pagar al retirar</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel simulador de pasarela -->
      <div class="card mt-3">
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Simular resultado pasarela</label>
              <select id="simResultado" class="form-select">
                <option value="aprobado">aprobado</option>
                <option value="rechazado">rechazado</option>
                <option value="doble">doble notificación (aprobado, aprobado)</option>
              </select>
            </div>
            <div class="col-md-6 d-grid d-md-flex justify-content-md-end">
              <button id="btnPagar" class="btn btn-success mt-2 mt-md-0">Pagar</button>
            </div>
          </div>
          <div class="form-text">Este selector es solo para demostrar los tres escenarios.</div>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">Resumen</h5>
          <div class="d-flex justify-content-between">
            <span>Total a pagar</span>
            <strong id="total">$0</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <span>Método seleccionado</span>
            <span id="lblMetodo" class="text-muted">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal éxito -->
  <div class="modal fade" id="modalOk" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Pago aprobado</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Tu pago fue procesado correctamente.</p>
          <p><strong>Pedido:</strong> <span id="okPedido"></span></p>
          <p><strong>Transacción:</strong> <span id="okTx"></span></p>
        </div>
        <div class="modal-footer">
          <a class="btn btn-success" href="index.html">Volver al inicio</a>
          <a class="btn btn-outline-secondary" href="B04catalogo.html">Seguir comprando</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal error -->
  <div class="modal fade" id="modalErr" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Pago rechazado</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>No pudimos procesar tu pago.</p>
          <p class="mb-0"><strong>Motivo:</strong> <span id="errMotivo"></span></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" data-bs-dismiss="modal">Intentar de nuevo</button>
          <a class="btn btn-outline-secondary" href="B11_pedido_detalle.html">Volver al pedido</a>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- app.js común -->
<script src="./assets/app.js"></script>

<script>
  // Por si quedó algo viejo de versiones anteriores
  try { localStorage.removeItem('carrito_b11'); } catch {}

  const KEY_PGOK = 'pagos_procesados_b14';

  function loadProcessed(){ return JSON.parse(localStorage.getItem(KEY_PGOK) || '[]'); }
  function saveProcessed(list){ localStorage.setItem(KEY_PGOK, JSON.stringify(list)); }

  // Total SIEMPRE desde el carrito actual
  function getTotal(){
    try {
      const raw = localStorage.getItem('mariachi_cart') || '[]';
      const cart = JSON.parse(raw);
      if (!Array.isArray(cart)) return 0;
      return cart.reduce(
        (acc, d) => acc + (d.precio * d.cantidad),
        0
      );
    } catch {
      return 0;
    }
  }

  const el = {
    total: document.getElementById('total'),
    lblMetodo: document.getElementById('lblMetodo'),
    metodos: document.getElementById('metodos'),
    simResultado: document.getElementById('simResultado'),
    btnPagar: document.getElementById('btnPagar')
  };

  const state = {
    metodo: null,
    total: getTotal(),
    pedidoId: localStorage.getItem('mariachi_pedido_id') || Date.now()
  };

  // Pintar total inicial
  el.total.textContent = `$${state.total.toLocaleString('es-CL')}`;

  // Selección de método
  el.metodos.addEventListener('click', (e)=>{
    const card = e.target.closest('.method-card');
    if(!card) return;
    document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    state.metodo = card.dataset.metodo;
    el.lblMetodo.textContent = state.metodo;
  });

  // Simulación de pasarela
  function simulateGateway(result){
    const txid = result==='doble' ? 'TX-' + (state.pedidoId) : 'TX-' + Date.now();
    if (result==='doble') {
      onGatewayCallback({estado:'aprobado', tx: txid, motivo:''});
      onGatewayCallback({estado:'aprobado', tx: txid, motivo:''});
    } else if (result==='aprobado') {
      onGatewayCallback({estado:'aprobado', tx: txid, motivo:''});
    } else {
      onGatewayCallback({estado:'rechazado', tx: txid, motivo:'Fondos insuficientes'});
    }
  }

  function alreadyProcessed(txid){
    const list = loadProcessed();
    return list.includes(txid);
  }
  function markProcessed(txid){
    const list = loadProcessed();
    if(!list.includes(txid)){ list.push(txid); saveProcessed(list); }
  }

  // Callback de la “pasarela”
  function onGatewayCallback({estado, tx, motivo}){
    toast(`Notificación: <b>${estado}</b> (tx=${tx})`);

    if (alreadyProcessed(tx)) {
      toast('Segunda notificación: ignorada (idempotencia)');
      return;
    }
    markProcessed(tx);

    if (estado==='aprobado') {
      // Vaciar carrito SOLO cuando el pago fue exitoso
      localStorage.removeItem('mariachi_cart');

      document.getElementById('okPedido').textContent = `#${state.pedidoId}`;
      document.getElementById('okTx').textContent = tx;
      new bootstrap.Modal(document.getElementById('modalOk')).show();
    } else {
      document.getElementById('errMotivo').textContent = motivo || 'Operación rechazada';
      new bootstrap.Modal(document.getElementById('modalErr')).show();
    }
  }

  // Click en Pagar
  el.btnPagar.addEventListener('click', ()=>{
    if (!state.metodo) {
      toast('Selecciona un método de pago.');
      return;
    }
    if (state.total<=0) {
      toast('No hay total para pagar.');
      return;
    }
    simulateGateway(el.simResultado.value);
  });

  // Helper para toasts
  function toast(html){
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="toast align-items-center text-bg-dark border-0 alert-fixed" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${html}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    const t = wrap.firstElementChild;
    document.body.appendChild(t);
    const bs = new bootstrap.Toast(t,{delay:3000});
    bs.show();
    t.addEventListener('hidden.bs.toast', ()=> t.remove());
  }
</script>
</body>
</html>
