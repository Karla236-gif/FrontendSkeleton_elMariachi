<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B13 ‚Äì Confirmar pedido</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --morado:#5E239D;
      --rosa:#C22972;
      --dorado:#FFD700;
      --morado-osc:#3E065F;
      --verde:#00A86B;
    }

    body{
      font-family:'Inter',sans-serif;
      background: linear-gradient(180deg,var(--morado) 0%,var(--rosa) 50%,#FDC830 100%);
      min-height:100vh;
    }

    .navbar{
      background:var(--morado-osc) !important;
    }
    .navbar-brand{
      font-family:"Baloo 2",cursive;
      color:var(--dorado) !important;
      text-shadow:2px 2px 5px #000;
      font-size:1.4rem;
    }
    .nav-link{
      color:#fff !important;
      font-weight:600;
    }

    h1,h2,h3,h4{
      font-family:"Baloo 2",cursive;
    }

    .page-card{
      background:#fff;
      border-radius:20px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      border:none;
    }

    .gherkin li{
      margin-bottom:.15rem;
    }

    .table thead{
      background:#f5f5f7;
    }

    .badge-cat{
      font-size:.8rem;
    }
  </style>
</head>
<body>

  <!-- NAVBAR (igual que el index, ajusta si tu versi√≥n es distinta) -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"> El Mariachi</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="B04catalogo.html">Cat√°logo</a></li>
          <li class="nav-item">
            <a class="nav-link" href="B11_pedido_detalle.html">
              üõí Carrito (<span id="cartCount">0</span>)
            </a>
          </li>
          <li class="nav-item"><a class="nav-link" href="B14pago.html">Pagar</a></li>
          <li class="nav-item"><a id="authLink" class="nav-link" href="B02login.html">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container py-4 py-md-5">

    <div class="row justify-content-center">
      <div class="col-12 col-xl-10">

        <div class="card page-card">
          <div class="card-body p-4 p-md-5">

            <!-- T√≠tulo -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
              <div>
                <h2 class="mb-1"> Confirmar pedido</h2>
                <p class="text-muted mb-0">Revisa el resumen antes de generar tu pedido.</p>
              </div>
              <a href="B04catalogo.html" class="btn btn-outline-secondary mt-3 mt-md-0">
                Seguir comprando
              </a>
            </div>

            <!-- Escenarios Gherkin -->
            <div class="mb-3">
              <h6 class="mb-1">Escenarios (Gherkin):</h6>
              <ul class="gherkin small mb-0">
                <li><strong>Escenario 1: Pedido v√°lido</strong> ‚Äî Dado que todos los √≠tems tienen stock, cuando el cliente presiona <em>‚ÄúConfirmar pedido‚Äù</em>, entonces el sistema genera el pedido sin errores.</li>
                <li><strong>Escenario 2: Producto agotado</strong> ‚Äî Dado que un √≠tem est√° sin stock, cuando el cliente presiona <em>‚ÄúConfirmar pedido‚Äù</em>, entonces el sistema bloquea la confirmaci√≥n y muestra un mensaje indicando el producto agotado.</li>
              </ul>
            </div>

            <!-- Resumen del pedido -->
            <div class="table-responsive mb-3">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="text-center" style="width:130px;">Cantidad</th>
                    <th class="text-end" style="width:140px;">P. Unitario</th>
                    <th class="text-end" style="width:160px;">Subtotal</th>
                  </tr>
                </thead>
                <tbody id="tbodyResumen">
                  <!-- filas din√°micas -->
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Total</th>
                    <th class="text-end" id="totalCell">$0</th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div id="msgB13" class="small mb-2 text-danger"></div>

            <div class="d-flex justify-content-end gap-2">
              <a href="B11_pedido_detalle.html" class="btn btn-outline-secondary">
                Volver al detalle
              </a>
              <button id="btnConfirmar" class="btn btn-success">
                Confirmar pedido
              </button>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal OK -->
  <div class="modal fade" id="modalOk" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Pedido generado</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="okMensaje" class="mb-2">Tu pedido fue generado correctamente.</p>
          <p class="mb-0">
            <strong>ID Pedido:</strong>
            <span id="okIdPedido"></span>
          </p>
        </div>
        <div class="modal-footer">
          <a href="B23_5misPedidos.html" class="btn btn-success">Ver mis pedidos</a>
          <a href="B14pago.html" class="btn btn-outline-light">Ir a pagar</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Archivo com√∫n con helpers de sesi√≥n, carrito y rutas API -->
  <script src="assets/app.js"></script>

  <script>
    // ==============================
    // 1) Contador de carrito (usa helpers de app.js)
    // ==============================
    function updateCartCountNav(){
      try{
        const span = document.getElementById('cartCount');
        if(!span || !window.getCart) return;
        const cart = getCart();
        const totalItems = cart.reduce((acc,it)=>acc + (it.cantidad || 0),0);
        span.textContent = totalItems;
      }catch(e){ console.warn(e); }
    }

    // ==============================
    // 2) Render del resumen
    // ==============================
    const tbody   = document.getElementById('tbodyResumen');
    const totalEl = document.getElementById('totalCell');
    const btnOk   = document.getElementById('btnConfirmar');
    const msgBox  = document.getElementById('msgB13');

    let totalActual = 0;

    function renderResumen(){
      const cart = (window.getCart ? getCart() : []);
      tbody.innerHTML = '';
      msgBox.textContent = '';
      totalActual = 0;

      if(!cart.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-4">
              Tu carrito est√° vac√≠o. Vuelve al cat√°logo para agregar productos.
            </td>
          </tr>`;
        totalEl.textContent = '$0';
        btnOk.disabled = true;
        return;
      }

      btnOk.disabled = false;

      const filas = cart.map(item=>{
        const cantidad = item.cantidad || 1;
        const precio   = Number(item.precio)||0;
        const subtotal = cantidad * precio;
        totalActual += subtotal;
        return `
          <tr>
            <td>${item.nombre}</td>
            <td class="text-center">${cantidad}</td>
            <td class="text-end">$${precio.toLocaleString('es-CL')}</td>
            <td class="text-end">$${subtotal.toLocaleString('es-CL')}</td>
          </tr>`;
      }).join('');

      tbody.innerHTML = filas;
      totalEl.textContent = '$'+ totalActual.toLocaleString('es-CL');
    }

    // ==============================
    // 3) Confirmar pedido ‚Üí API / Mongo
    // ==============================
    async function confirmarPedido(){
      const cart = (window.getCart ? getCart() : []);
      if(!cart.length){
        msgBox.textContent = 'No hay productos para confirmar.';
        return;
      }

      const user  = window.getSession ? getSession() : null;
      const email = user?.email || 'cliente@test.com';

      const payload = {
        clienteEmail: email,
        items: cart.map(it=>({
          idProducto: it.id,
          nombre: it.nombre,
          cantidad: it.cantidad || 1,
          precio: it.precio
        })),
        total: totalActual,
        estado: 'pendiente'
      };

      try{
        msgBox.textContent = 'Enviando pedido‚Ä¶';

        const res = await fetch(`${API_BASE}/api/pedidos`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));

        if(!res.ok){
          msgBox.textContent = data.error || 'No se pudo generar el pedido.';
          return;
        }

        // Tomamos el id devuelto en cualquiera de estos campos
        const idPedido = data._id || data.id || data.pedidoId || (data.pedido && data.pedido._id) || '‚Äî';

        // Guardar √∫ltimo pedido para B14 si quieres usarlo all√≠
        try{
          localStorage.setItem('mariachi_last_pedido', idPedido);
        }catch(e){}

        // Vaciar carrito
        if(window.setCart) setCart([]);
        updateCartCountNav();

        // Mostrar modal OK
        document.getElementById('okIdPedido').textContent = idPedido;
        document.getElementById('okMensaje').textContent  = 'Tu pedido fue generado y almacenado en el sistema.';
        new bootstrap.Modal(document.getElementById('modalOk')).show();

        msgBox.textContent = '';

      }catch(err){
        console.error(err);
        msgBox.textContent = 'Error de conexi√≥n al generar el pedido.';
      }
    }

    // ==============================
    // 4) Arranque
    // ==============================
    document.addEventListener('DOMContentLoaded', ()=>{
      updateCartCountNav();
      renderResumen();
      btnOk.addEventListener('click', confirmarPedido);
    });
  </script>
</body>
</html>
  