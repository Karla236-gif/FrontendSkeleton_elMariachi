<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B12 ‚Äì Pedido: modificar/eliminar</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  .qty-select{width:90px}
  .qty-box{max-width:140px}
</style>
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- F1: Gherkin -->
  <div class="mb-3">
    <h5><strong>Escenarios (Gherkin):</strong></h5>
    <ul class="mb-0">
      <li><b>Escenario 1: Aumentar cantidad</b> ‚Äî Dado un √≠tem con cantidad 1, cuando el cliente presiona ‚Äú+‚Äù (o elige 2 en el selector), entonces la cantidad pasa a 2 y el subtotal se actualiza.</li>
      <li><b>Escenario 2: Eliminar √≠tem</b> ‚Äî Dado un √≠tem en el pedido, cuando el cliente presiona ‚ÄúEliminar‚Äù y confirma, entonces el √≠tem desaparece y el total se recalcula.</li>
    </ul>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">üßæ Modificar pedido</h4>
        <div class="d-flex gap-2">
          <a href="B04catalogo.html" class="btn btn-outline-secondary btn-sm">Seguir comprando</a>
          <a href="B14pago.html" class="btn btn-success btn-sm">Ir a pagar</a>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th class="text-center">Cantidad</th>
              <th class="text-end">P. Unitario</th>
              <th class="text-end">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end" id="totalCell">$0</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- F4: Modal confirmaci√≥n eliminar -->
  <div class="modal fade" id="modalDel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Eliminar √≠tem</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ¬øSeguro que deseas eliminar <strong id="delNombre">este producto</strong> del pedido?
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnDelConfirm" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- F5: Clase PedidoDetalle -->
  <div class="mt-4">
    <h6>Clase <code>PedidoDetalle</code> (B11/B12):</h6>
<pre class="bg-white p-3 border rounded"><code>PedidoDetalle {
  idDetalle: Integer
  idPedido: Integer
  idProducto: Integer
  nombreProducto: String
  cantidad: Integer
  precioUnitario: Float
  subtotal: Float
}</code></pre>
  </div>
</div>

<script>
  // === Estado (mismo carrito que B11)
  const KEY_CART = 'carrito_b11';
  function load(){ return JSON.parse(localStorage.getItem(KEY_CART) || '[]'); }
  function save(c){ localStorage.setItem(KEY_CART, JSON.stringify(c)); }

  const tbody = document.getElementById('tbody');
  const totalCell = document.getElementById('totalCell');

  // Render tabla
  function render(){
    const cart = load();
    if (cart.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tu pedido est√° vac√≠o.</td></tr>`;
      totalCell.textContent = '$0';
      return;
    }
    tbody.innerHTML = cart.map(d => `
      <tr data-id="${d.idProducto}">
        <td>${d.nombreProducto}</td>

        <!-- Select 1‚Äì10 + botones +/- -->
        <td class="text-center" style="width:230px">
          <div class="d-flex justify-content-center gap-2">
            <div class="input-group input-group-sm qty-box">
              <button class="btn btn-outline-secondary btn-minus">‚àí</button>
              <input type="number" class="form-control text-center qty-input" value="${d.cantidad}" min="1">
              <button class="btn btn-outline-secondary btn-plus">+</button>
            </div>
            <select class="form-select form-select-sm qty-select">
              ${Array.from({length:10}, (_,i)=>i+1).map(n => `
                <option value="${n}" ${n===d.cantidad?'selected':''}>${n}</option>
              `).join('')}
            </select>
          </div>
        </td>

        <td class="text-end">$${d.precioUnitario}</td>
        <td class="text-end item-subtotal">$${d.subtotal}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger btn-del" data-name="${d.nombreProducto}">Eliminar</button></td>
      </tr>
    `).join('');

    const total = cart.reduce((acc, it) => acc + it.subtotal, 0);
    totalCell.textContent = `$${total}`;
  }

  // Helpers de cantidad/subtotal
  function updateQty(idProducto, nuevaCantidad){
    let cart = load();
    const item = cart.find(i => i.idProducto === idProducto);
    if (!item) return;
    item.cantidad = Math.max(1, nuevaCantidad|0);
    item.subtotal = item.cantidad * item.precioUnitario;
    save(cart); render();
  }

  // Eventos: +/-, input num√©rico, select 1‚Äì10
  tbody.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    const id = parseInt(tr.dataset.id,10);
    const input = tr.querySelector('.qty-input');
    if (e.target.classList.contains('btn-minus')) updateQty(id, (parseInt(input.value||1,10)-1));
    if (e.target.classList.contains('btn-plus'))  updateQty(id, (parseInt(input.value||1,10)+1));
  });

  tbody.addEventListener('change', (e)=>{
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    const id = parseInt(tr.dataset.id,10);
    if (e.target.classList.contains('qty-input'))  updateQty(id, parseInt(e.target.value||1,10));
    if (e.target.classList.contains('qty-select')) updateQty(id, parseInt(e.target.value,10));
  });

  // Eliminar con modal (Escenario 2)
  let delId = null;
  const modalEl = document.getElementById('modalDel');
  const modal = new bootstrap.Modal(modalEl);
  const delNameEl = document.getElementById('delNombre');

  tbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-del'); if(!btn) return;
    const tr = btn.closest('tr[data-id]');
    delId = parseInt(tr.dataset.id,10);
    delNameEl.textContent = btn.dataset.name || 'este producto';
    modal.show();
  });

  document.getElementById('btnDelConfirm').addEventListener('click', ()=>{
    if (delId==null) return;
    let cart = load().filter(i => i.idProducto !== delId);
    save(cart);
    modal.hide();
    render();
  });

  // Init
  render();
</script>
</body>
</html>
  