<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B05 ‚Äì B√∫squeda/Filtros</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: linear-gradient(180deg, #5E239D 0%, #C22972 50%, #FDC830 100%);
      min-height: 100vh;
      color: #fff;
    }
    h2 {
      color: #FFD700;
      text-shadow: 2px 2px 4px #000;
    }
    .card {
      border-radius: 12px;
    }
  </style>
</head>
<body>

<div class="container py-4">

  <h2 class="mb-4 text-center">üåÆ Resultados de B√∫squeda</h2>

  <!-- Mostrar par√°metros recibidos -->
  <div id="params" class="alert alert-info"></div>

  <!-- Contenedor de resultados -->
  <div id="resultados" class="row g-4 mt-3"></div>

</div>

<!-- üîπ Script com√∫n con API_BASE / API_PRODUCTOS -->
<script src="assets/app.js"></script>


<script>
  // === 1. Leer par√°metros de b√∫squeda de la URL ===
  const params = new URLSearchParams(window.location.search);
  const q   = (params.get('q')   || '').trim();
  const cat = (params.get('cat') || '').trim();

  // Mostrar par√°metros en pantalla (para depuraci√≥n)
  document.getElementById('params').innerHTML =
    `<strong>Par√°metros:</strong> q = "${q}" | cat = "${cat}"`;

  const cont = document.getElementById('resultados');

  // === 2. Construir URL hacia la API de productos ===
  // API_PRODUCTOS viene definido en app.js
  const url = new URL(API_PRODUCTOS);
  if (q)   url.searchParams.set('q', q);
  if (cat) url.searchParams.set('cat', cat);

  // === 3. Llamar al backend y mostrar resultados ===
  async function cargarBusqueda() {
    try {
      cont.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-warning mb-0">Cargando resultados‚Ä¶</div>
        </div>
      `;

      const resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      let productos = await resp.json();

      // Si tu backend a√∫n NO filtra por q/cat,
      // hacemos un filtrado extra en el frontend:
      if (q) {
        const qLower = q.toLowerCase();
        productos = productos.filter(p =>
          String(p.nombre || '').toLowerCase().includes(qLower)
        );
      }
      if (cat) {
        const catLower = cat.toLowerCase();
        productos = productos.filter(p =>
          String(p.categoria || '').toLowerCase() === catLower
        );
      }

      if (!Array.isArray(productos) || productos.length === 0) {
        cont.innerHTML = `
          <div class="col-12 text-center">
            <div class="alert alert-light text-dark">
              üòï No se encontraron resultados para tu b√∫squeda.
            </div>
          </div>
        `;
        return;
      }

      cont.innerHTML = productos.map(p => `
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm">
            <img src="${p.imgUrl || 'assets/ImagenesMariachi/placeholder.jpg'}"
                 class="card-img-top" alt="${p.nombre}">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-1">${p.nombre}</h5>
              <span class="badge bg-secondary text-uppercase mb-2">
                ${p.categoria || 'sin categor√≠a'}
              </span>
              <p class="mt-2 mb-3 fw-bold">
                $${Number(p.precio || 0).toLocaleString('es-CL')}
              </p>
              <a href="B06productodetalle.html?id=${p._id}"
                 class="btn btn-success btn-sm mt-auto">
                Ver detalle
              </a>
            </div>
          </div>
        </div>
      `).join('');

    } catch (err) {
      console.error('Error en b√∫squeda:', err);
      cont.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-danger">
            Error al cargar resultados. Revisa que el backend est√© activo
            en <code>${API_BASE}</code>.
          </div>
        </div>
      `;
    }
  }

  cargarBusqueda();
</script>

</body>
</html>
