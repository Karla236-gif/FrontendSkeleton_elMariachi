<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>B19 ‚Äì Bit√°cora</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  body { background:#f7f7fb }
  .chip { padding:.15rem .55rem; border-radius:999px; font-size:.78rem; border:1px solid #e5e7eb; background:#fff }
</style>
</head>
<body>
<div class="container py-4">

  <h3 class="mb-3">üîç Consulta de bit√°cora</h3>

  <!-- ====== Filtros ====== -->
  <div class="row mb-3 g-2">
    <div class="col-md-3">
      <label for="fDesde" class="form-label">Desde</label>
      <input type="date" id="fDesde" class="form-control" />
    </div>
    <div class="col-md-3">
      <label for="fHasta" class="form-label">Hasta</label>
      <input type="date" id="fHasta" class="form-control" />
    </div>
    <div class="col-md-3">
      <label for="fTipo" class="form-label">Tipo operaci√≥n</label>
      <select id="fTipo" class="form-select">
        <option value="">(todos)</option>
        <option value="CREAR">CREAR</option>
        <option value="EDITAR">EDITAR</option>
        <option value="ANULAR">ANULAR</option>
        <option value="PAGO">PAGO</option>
        <option value="LOGIN">LOGIN</option>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </div>

  <!-- ====== Tabla ====== -->
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="tablaBitacora">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Fecha/Hora</th>
          <th>Usuario</th>
          <th>Tipo</th>
          <th>Entidad</th>
          <th>Referencial</th>
          <th>Resultado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ====== Detalle de registro (para escenario 3) ====== -->
  <section id="panelDetalle" class="card p-3 mt-4 d-none">
    <h5 class="mb-3">üóÇÔ∏è Detalle de registro</h5>
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">ID</label>
        <input id="dId" class="form-control" disabled>
      </div>
      <div class="col-md-3">
        <label class="form-label">Tipo</label>
        <input id="dTipo" class="form-control" disabled>
      </div>
      <div class="col-md-3">
        <label class="form-label">Entidad</label>
        <input id="dEntidad" class="form-control" disabled>
      </div>
      <div class="col-md-4">
        <label class="form-label">Referencial</label>
        <input id="dRef" class="form-control" disabled>
      </div>
      <div class="col-12">
        <label class="form-label">Detalles</label>
        <textarea id="dDetalles" class="form-control" rows="2"
          placeholder="(s√≥lo para demostrar bloqueo de edici√≥n)"></textarea>
      </div>
      <div class="col-12 d-flex gap-2">
        <button id="btnIntentarEditar" class="btn btn-warning">Guardar cambios</button>
        <button id="btnIntentarEliminar" class="btn btn-outline-danger">Eliminar</button>
        <span id="inmutableBadge" class="ms-auto text-danger fw-semibold d-none">
          Registro inmutable: no se puede editar ni eliminar.
        </span>
      </div>
    </div>
  </section>

  <!-- ====== Crear cliente ====== -->
  <section class="card p-3 mt-4">
    <h5 class="mb-2">üë§ Crear cliente</h5>
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Nombre</label>
        <input id="cliNombre" class="form-control" placeholder="Ana Demo">
      </div>
      <div class="col-md-4">
        <label class="form-label">Correo</label>
        <input id="cliCorreo" type="email" class="form-control" placeholder="ana@demo.com">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button id="btnCrearCliente" class="btn btn-success">Guardar</button>
      </div>
    </div>
    <div id="cliMsg" class="mt-2"></div>
  </section>

  <!-- ====== Controles demo ====== -->
  <div class="d-flex gap-2 mt-4">
    <input id="who" class="form-control w-auto" placeholder="admin@elmariachi.cl" value="admin@elmariachi.cl" />
    <select id="rol" class="form-select w-auto">
      <option>admin</option>
      <option>cajero</option>
      <option>cliente</option>
    </select>
    <button id="btnSeed" class="btn btn-success">Cargar demo</button>
    <button id="btnClear" class="btn btn-danger">Vaciar bit√°cora</button>
  </div>
</div>

<!-- ===== Modal bloqueo (escenario 3) ===== -->
<div class="modal fade" id="modalBloqueo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Acci√≥n no permitida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBloqueoMsg">
        Este registro es inmutable y no puede modificarse ni eliminarse.
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =====================================================
   BIT√ÅCORA BASE
===================================================== */
const KEY = 'b19_bitacora';
const load = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } };
const save = (l) => localStorage.setItem(KEY, JSON.stringify(l));

/* ===== Render tabla (con selecci√≥n por click) ===== */
function renderTabla(lista){
  const tbody = document.querySelector('#tablaBitacora tbody');
  tbody.innerHTML = '';
  if(!lista.length){
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Sin resultados.</td></tr>`;
    document.getElementById('panelDetalle').classList.add('d-none');
    return;
  }
  for(const r of lista){
    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${new Date(r.fechaHora).toLocaleString('es-CL')}</td>
      <td>${r.usuario}</td>
      <td><span class="chip">${r.tipoOperacion}</span></td>
      <td>${r.entidad}</td>
      <td>${r.referencial ?? '-'}</td>
      <td>${r.resultado}</td>`;
    tr.addEventListener('click', ()=> verDetalle(r.id));
    tbody.appendChild(tr);
  }
}

/* ===== Filtro ===== */
function filtrar(){
  const d0 = document.getElementById('fDesde').value ? new Date(document.getElementById('fDesde').value) : new Date('2000-01-01');
  const d1 = document.getElementById('fHasta').value ? new Date(document.getElementById('fHasta').value) : new Date('2100-01-01');
  d1.setHours(23,59,59,999);
  const tipo = document.getElementById('fTipo').value;
  const out = load().filter(r=>{
    const f = new Date(r.fechaHora);
    return f>=d0 && f<=d1 && (!tipo || r.tipoOperacion===tipo);
  });
  renderTabla(out);
}
document.getElementById('btnFiltrar').addEventListener('click', filtrar);

/* ===== Rango completo ===== */
function setFullRangeAndTypeAll() {
  const hoy = new Date();
  const desde = new Date(hoy.getFullYear(), 0, 1);
  const hasta = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);
  document.getElementById('fDesde').value = desde.toISOString().slice(0,10);
  document.getElementById('fHasta').value = hasta.toISOString().slice(0,10);
  document.getElementById('fTipo').value = ""; // (todos)
}

/* ===== Vaciar bit√°cora ===== */
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(confirm('¬øVaciar bit√°cora?')){
    localStorage.removeItem(KEY);
    filtrar();
  }
});

/* ===== Cargar demo (CREAR incluido, todos con inmutable:true) ===== */
document.getElementById('btnSeed').addEventListener('click', ()=>{
  const list = load();
  const nextId = (l)=> (l.at(-1)?.id || 0) + 1;
  const baseId = nextId(list);
  const now = Date.now();

  const rows = [
    {tipoOperacion:'LOGIN',  entidad:'Usuario',  referencial:'admin@elmariachi.cl', resultado:'OK', detalles:'Inicio de sesi√≥n'},
    {tipoOperacion:'PAGO',   entidad:'Pedido',   referencial:10025,                 resultado:'OK', detalles:'Pago aprobado'},
    {tipoOperacion:'ANULAR', entidad:'Pedido',   referencial:10010,                 resultado:'OK', detalles:'Anulaci√≥n por cliente'},
    {tipoOperacion:'EDITAR', entidad:'Producto', referencial:501,                   resultado:'OK', detalles:'Cambio de precio'},
    {tipoOperacion:'CREAR',  entidad:'Cliente',  referencial:'ana@demo.com',        resultado:'OK', detalles:"Alta de cliente 'Ana Demo'"},
  ].map((x,i)=>({
    id: baseId + i,
    fechaHora: new Date(now - (i*3600_000)).toISOString(),
    usuario: `${document.getElementById('who').value} (${document.getElementById('rol').value})`,
    inmutable: true,
    ...x
  }));

  save(list.concat(rows));
  setFullRangeAndTypeAll();
  filtrar();
  alert('Registros demo cargados (incluye CREAR).');
});

/* =====================================================
   DETALLE + BLOQUEO (Escenario 3)
===================================================== */
let selId = null;

function verDetalle(id){
  const reg = load().find(x => x.id === id);
  if(!reg) return;

  selId = id;
  document.getElementById('panelDetalle').classList.remove('d-none');
  document.getElementById('dId').value = reg.id;
  document.getElementById('dTipo').value = reg.tipoOperacion;
  document.getElementById('dEntidad').value = reg.entidad;
  document.getElementById('dRef').value = reg.referencial ?? '';
  document.getElementById('dDetalles').value = reg.detalles ?? '';

  const inmutable = reg.inmutable !== false; // por defecto true
  document.getElementById('inmutableBadge').classList.toggle('d-none', !inmutable);
}

function mostrarBloqueo(msg){
  document.getElementById('modalBloqueoMsg').textContent =
    msg || 'Este registro es inmutable y no puede modificarse ni eliminarse.';
  const m = new bootstrap.Modal(document.getElementById('modalBloqueo'));
  m.show();
}

document.getElementById('btnIntentarEditar').addEventListener('click', ()=>{
  if(selId == null) return;
  const reg = load().find(x => x.id === selId);
  if(!reg) return;
  if(reg.inmutable !== false){
    mostrarBloqueo('No es posible editar un registro de bit√°cora (inmutable).');
    return;
  }
  // (Si quisieras permitir edici√≥n en casos especiales, aqu√≠ va la l√≥gica)
});

document.getElementById('btnIntentarEliminar').addEventListener('click', ()=>{
  if(selId == null) return;
  const reg = load().find(x => x.id === selId);
  if(!reg) return;
  if(reg.inmutable !== false){
    mostrarBloqueo('No es posible eliminar un registro de bit√°cora (inmutable).');
    return;
  }
  // (Si quisieras permitir eliminaci√≥n en casos especiales, aqu√≠ va la l√≥gica)
});

/* =====================================================
   CREAR CLIENTE + REGISTRAR EN BIT√ÅCORA
===================================================== */
const KEY_CLIENTES = 'clientes';
const loadClientes = () => { try { return JSON.parse(localStorage.getItem(KEY_CLIENTES) || '[]'); } catch { return []; } };
const saveClientes = (l) => localStorage.setItem(KEY_CLIENTES, JSON.stringify(l));
const nextIdClient = (l) => (l.at(-1)?.id || 0) + 1;

document.getElementById('btnCrearCliente').addEventListener('click', ()=>{
  const nombre = (document.getElementById('cliNombre').value || '').trim();
  const correoInput = document.getElementById('cliCorreo');
  const correo = (correoInput.value || '').trim().toLowerCase();
  const msg = document.getElementById('cliMsg');

  if(!nombre || !correo){
    msg.innerHTML = `<div class="alert alert-warning">Completa nombre y correo.</div>`;
    return;
  }
  if(!correoInput.checkValidity()){
    msg.innerHTML = `<div class="alert alert-danger">Correo inv√°lido.</div>`;
    return;
  }

  let clientes = loadClientes();
  if (clientes.some(c => c.correo === correo)){
    msg.innerHTML = `<div class="alert alert-info">Ese correo ya existe.</div>`;
    return;
  }

  const idCliente = nextIdClient(clientes);
  const nuevo = { id: idCliente, nombre, correo, fechaAlta: new Date().toISOString() };
  clientes.push(nuevo);
  saveClientes(clientes);

  // Registrar en bit√°cora (CREAR)
  const bit = load();
  const idBit = (bit.at(-1)?.id || 0) + 1;
  bit.push({
    id: idBit,
    fechaHora: new Date().toISOString(),
    usuario: `${document.getElementById('who').value} (${document.getElementById('rol').value})`,
    tipoOperacion: 'CREAR',
    entidad: 'Cliente',
    referencial: correo,
    resultado: 'OK',
    detalles: `Alta de cliente '${nombre}'`,
    inmutable: true
  });
  save(bit);

  msg.innerHTML = `<div class="alert alert-success">Cliente <strong>${nombre}</strong> creado y registrado en bit√°cora.</div>`;
  document.getElementById('cliNombre').value = '';
  document.getElementById('cliCorreo').value = '';
  setFullRangeAndTypeAll();
  document.getElementById('fTipo').value = 'CREAR';
  filtrar();
  setTimeout(()=> msg.innerHTML = '', 2500);
});

/* ===== Inicializaci√≥n ===== */
window.addEventListener('load', ()=>{
  setFullRangeAndTypeAll();
  filtrar();
});
</script>
</body>
</html>
