<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B11 â€“ Detalle del pedido</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .qty { width: 90px; }
    .card img { height: 180px; object-fit: cover; }
    .table td,.table th{vertical-align:middle}
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">ðŸ§¾ Detalle del pedido</h3>
      <a class="btn btn-outline-secondary" href="B04catalogo.html">Seguir comprando</a>
    </div>

  

    <!-- Tabla del carrito -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">P. Unitario</th>
                <th class="text-end">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbodyCarrito"></tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Total</th>
                <th class="text-end" id="totalCell">$0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button id="btnCheckout" class="btn btn-primary">Confirmar pedido</button>
          <a href="B14pago.html" class="btn btn-success">Continuar compra</a>
        </div>
        <div id="orderMsg" class="mt-2 small"></div>
      </div>
    </div>

  </div> <!-- /container -->

  <!-- app.js comÃºn (ajusta ruta si no estÃ¡ en /assets) -->
  <script src="./assets/app.js"></script>

  <!-- SCRIPT DE B11 -->
  <script>
    // ================================
    // Config API pedidos
    // ================================
    const API_PEDIDOS = `${API_BASE}/api/pedidos`;

    // ================================
    // Carrito local (compartido con B04/B06)
    // ================================
    function getCarrito() {
      try {
        return JSON.parse(localStorage.getItem('mariachi_cart')) || [];
      } catch {
        return [];
      }
    }

    function saveCarrito(carrito) {
      localStorage.setItem('mariachi_cart', JSON.stringify(carrito));
    }

    // ================================
    // Utils
    // ================================
    function formatCL(n) {
      return `$${Number(n || 0).toLocaleString('es-CL')}`;
    }

    const tbody       = document.getElementById('tbodyCarrito');
    const totalCell   = document.getElementById('totalCell');
    const orderMsg    = document.getElementById('orderMsg');
    const btnCheckout = document.getElementById('btnCheckout');

    // ================================
    // Render del carrito
    // ================================
    function renderCarrito(){
      const carrito = getCarrito();

      if (!carrito.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tu pedido estÃ¡ vacÃ­o.</td></tr>`;
        totalCell.textContent = '$0';
        btnCheckout.disabled = true;
        return;
      }

      btnCheckout.disabled = false;

      tbody.innerHTML = carrito.map(it => `
        <tr data-id="${it.id}">
          <td>${it.nombre}</td>
          <td class="text-center" style="width:160px">
            <div class="input-group input-group-sm mx-auto" style="max-width:140px">
              <button class="btn btn-outline-secondary btn-minus">âˆ’</button>
              <input type="number" class="form-control text-center qty" value="${it.cantidad}" min="1">
              <button class="btn btn-outline-secondary btn-plus">+</button>
            </div>
          </td>
          <td class="text-end">${formatCL(it.precio)}</td>
          <td class="text-end item-subtotal">${formatCL(it.precio * it.cantidad)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger btn-del">Quitar</button>
          </td>
        </tr>
      `).join('');

      const total = carrito.reduce((s,i)=> s + i.precio * i.cantidad, 0);
      totalCell.textContent = formatCL(total);
    }

    // ================================
    // Eventos + / âˆ’ / Quitar
    // ================================
    tbody.addEventListener('click', (e) => {
      const tr = e.target.closest('tr[data-id]');
      if (!tr) return;
      const id = tr.dataset.id;

      let carrito = getCarrito();
      const item = carrito.find(p => p.id === id);
      if (!item) return;

      if (e.target.classList.contains('btn-minus')) {
        item.cantidad = Math.max(1, item.cantidad - 1);
      }
      if (e.target.classList.contains('btn-plus')) {
        item.cantidad += 1;
      }
      if (e.target.classList.contains('btn-del')) {
        carrito = carrito.filter(p => p.id !== id);
        saveCarrito(carrito);
        renderCarrito();
        return;
      }

      saveCarrito(carrito);
      renderCarrito();
    });

    // Cambio manual de cantidad
    tbody.addEventListener('change', (e) => {
      const tr = e.target.closest('tr[data-id]');
      if (!tr || !e.target.classList.contains('qty')) return;

      const id  = tr.dataset.id;
      const qty = Math.max(1, parseInt(e.target.value || 1, 10));

      const carrito = getCarrito();
      const item = carrito.find(p => p.id === id);
      if (!item) return;

      item.cantidad = qty;
      saveCarrito(carrito);
      renderCarrito();
    });

    // ================================
    // Confirmar pedido â†’ POST /api/pedidos
    // ================================
    btnCheckout.addEventListener('click', async () => {
      const user    = getSession();         // viene de app.js
      const carrito = getCarrito();

      orderMsg.className = 'mt-2 small';

      if (!user){
        orderMsg.textContent = 'Debes iniciar sesiÃ³n para confirmar el pedido.';
        orderMsg.classList.add('text-danger');
        return;
      }
      if (!carrito.length){
        orderMsg.textContent = 'Tu carrito estÃ¡ vacÃ­o.';
        orderMsg.classList.add('text-danger');
        return;
      }

      orderMsg.textContent = 'Enviando pedidoâ€¦';
      orderMsg.classList.remove('text-danger', 'text-success');
      orderMsg.classList.add('text-muted');

      try {
        const res = await fetch(API_PEDIDOS, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            userId: user._id,
            items: carrito
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false){
          orderMsg.textContent = data.msg || 'Error al crear el pedido.';
          orderMsg.classList.remove('text-muted');
          orderMsg.classList.add('text-danger');
          return;
        }

        // âœ… Pedido creado correctamente en la API
        const pedidoCreado = data.pedido || data;   // ajusta si tu API devuelve otra estructura
        localStorage.setItem('mariachi_pedido_actual', JSON.stringify(pedidoCreado));

        // Vaciar carrito
        saveCarrito([]);
        renderCarrito();

        orderMsg.textContent = 'âœ… Pedido confirmado correctamente. Redirigiendoâ€¦';
        orderMsg.classList.remove('text-muted');
        orderMsg.classList.add('text-success');

        // Ir a B13 (ajusta nombre real del archivo si es distinto)
        setTimeout(() => {
          window.location.href = 'B13pedidoConfirmar.html';
        }, 800);

      } catch (err){
        console.error('Error al enviar pedido:', err);
        orderMsg.textContent = 'Error de red al contactar la API.';
        orderMsg.classList.remove('text-muted');
        orderMsg.classList.add('text-danger');
      }
    });

    // ================================
    // Init
    // ================================
    renderCarrito();
  </script>
</body>
</html>

