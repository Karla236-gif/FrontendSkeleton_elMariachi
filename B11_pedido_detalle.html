<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B11 ‚Äì Pedido: agregar/ver</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .qty { width: 90px; }
    .card img { height: 180px; object-fit: cover; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">üßæ Detalle del pedido</h3>
      <a class="btn btn-outline-secondary" href="B04catalogo.html">Seguir comprando</a>
    </div>

    <!-- Gherkin -->
    <div class="mb-3">
      <h6 class="fw-bold">Escenarios (Gherkin)</h6>
      <ul class="mb-0">
        <li><b>Agregar producto:</b> al presionar ‚ÄúAgregar al carrito‚Äù en cat√°logo o detalle, el producto aparece aqu√≠ con su cantidad.</li>
        <li><b>Ver detalle actualizado:</b> al abrir esta vista, se muestran cantidades, subtotales y el total correctos.</li>
        <li><b>Confirmar pedido:</b> al presionar ‚ÄúConfirmar pedido‚Äù, se env√≠a el carrito a la API y se vac√≠a si todo va bien.</li>
      </ul>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">P. Unitario</th>
                <th class="text-end">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbodyCarrito"></tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Total</th>
                <th class="text-end" id="totalCell">$0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button id="btnCheckout" class="btn btn-primary">Confirmar pedido</button>
          <a href="B14pago.html" class="btn btn-success">Continuar compra</a>
        </div>
        <div id="orderMsg" class="mt-2 small text-muted"></div>
      </div>
    </div>

    <!-- Clase PedidoDetalle (mock documental) -->
    <div class="mt-4">
      <h6>Clase <code>PedidoDetalle</code> (referencia)</h6>
<pre class="bg-white p-3 border rounded"><code>PedidoDetalle {
  idDetalle: Integer
  idPedido:  Integer
  idProducto: String  // _id de Mongo del producto
  nombreProducto: String
  cantidad: Integer
  precioUnitario: Number
  subtotal: Number
}</code></pre>
    </div>
  </div>

  <!-- L√≥gica com√∫n -->
  <script src="assets/app.js"></script>

  <!-- L√≥gica espec√≠fica B11 -->
  <script>
    // Solo construimos API_ORDENES usando la global que trae app.js (sin redeclarar API_BASE)
    const API_ORDENES =
      `${(typeof window.API_BASE === 'string' ? window.API_BASE : 'http://localhost:3000')}/api/pedidos`;

    function getCart(){
      try { return JSON.parse(localStorage.getItem('mariachi_cart')) || []; }
      catch { return []; }
    }
    function setCart(c){ localStorage.setItem('mariachi_cart', JSON.stringify(c)); }
    function getSession(){
      try { return JSON.parse(localStorage.getItem('mariachi_user')) || null; }
      catch { return null; }
    }
    function formatCL(n){ return `$${Number(n || 0).toLocaleString('es-CL')}`; }

    const tbody     = document.getElementById('tbodyCarrito');
    const totalCell = document.getElementById('totalCell');

    function renderCart(){
      const cart = getCart(); // [{ _id, nombre, precio, qty }]
      if (!cart.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tu pedido est√° vac√≠o.</td></tr>`;
        totalCell.textContent = '$0';
        return;
      }

      tbody.innerHTML = cart.map(it => `
        <tr data-id="${it._id}">
          <td>${it.nombre}</td>
          <td class="text-center" style="width:160px">
            <div class="input-group input-group-sm mx-auto" style="max-width:140px">
              <button class="btn btn-outline-secondary btn-minus">‚àí</button>
              <input type="number" class="form-control text-center qty" value="${it.qty}" min="1">
              <button class="btn btn-outline-secondary btn-plus">+</button>
            </div>
          </td>
          <td class="text-end">${formatCL(it.precio)}</td>
          <td class="text-end item-subtotal">${formatCL(it.precio * it.qty)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger btn-del">Quitar</button>
          </td>
        </tr>
      `).join('');

      const total = cart.reduce((s,i)=> s + i.precio*i.qty, 0);
      totalCell.textContent = formatCL(total);
    }

    // Eventos + / ‚àí / Quitar
    tbody.addEventListener('click', (e) => {
      const tr = e.target.closest('tr[data-id]'); if(!tr) return;
      const id = tr.dataset.id;
      let cart = getCart();
      const it = cart.find(x => x._id === id); if(!it) return;

      if (e.target.classList.contains('btn-minus')) it.qty = Math.max(1, it.qty - 1);
      if (e.target.classList.contains('btn-plus'))  it.qty += 1;
      if (e.target.classList.contains('btn-del')) {
        cart = cart.filter(x => x._id !== id);
        setCart(cart); renderCart(); return;
      }
      setCart(cart); renderCart();
    });

    // Cambio manual de cantidad
    tbody.addEventListener('change', (e)=>{
      const tr = e.target.closest('tr[data-id]');
      if (!tr || !e.target.classList.contains('qty')) return;
      const id  = tr.dataset.id;
      const qty = Math.max(1, parseInt(e.target.value||1,10));
      const cart = getCart();
      const it = cart.find(x => x._id === id);
      if (!it) return;
      it.qty = qty;
      setCart(cart); renderCart();
    });

    // Confirmar pedido -> POST /api/pedidos
    const btnCheckout = document.getElementById('btnCheckout');
    if (btnCheckout){
      btnCheckout.addEventListener('click', async ()=>{
        const msg  = document.getElementById('orderMsg');
        const user = getSession();
        const items = getCart();
        if (!user){ msg.textContent = 'Debes iniciar sesi√≥n.'; return; }
        if (!items.length){ msg.textContent = 'Carrito vac√≠o.'; return; }

        msg.textContent = 'Enviando pedido‚Ä¶';
        try{
          const res = await fetch(API_ORDENES, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ userId: user._id, items })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok){ msg.textContent = data.msg || 'Error al crear pedido'; return; }
          msg.textContent = '‚úÖ Pedido confirmado';
          localStorage.removeItem('mariachi_cart');
          renderCart();
        }catch(err){
          console.error(err);
          msg.textContent = 'Error de red';
        }
      });
    }

    // Init
    renderCart();
  </script>
</body>
</html>
