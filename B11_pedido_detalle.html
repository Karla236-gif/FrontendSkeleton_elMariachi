<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>B11 ‚Äì Pedido: agregar/ver</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  .qty { width: 90px; }
  .card img { height: 180px; object-fit: cover; }
</style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">üßæ Detalle del pedido</h3>
    <a class="btn btn-outline-secondary" href="B04catalogo.html">Seguir comprando</a>
  </div>

  <!-- Gherkin -->
  <div class="mb-3">
    <h6 class="fw-bold">Escenarios (Gherkin)</h6>
    <ul class="mb-0">
      <li><b>Agregar producto:</b> al presionar ‚ÄúAgregar al pedido‚Äù en cat√°logo, el producto aparece aqu√≠ con cantidad 1 (o la indicada).</li>
      <li><b>Ver detalle actualizado:</b> al abrir esta vista, se muestran cantidades, subtotales y el total correctos.</li>
    </ul>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th class="text-center">Cantidad</th>
              <th class="text-end">P. Unitario</th>
              <th class="text-end">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbodyCarrito"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end" id="totalCell">$0</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <a href="B14pago.html" class="btn btn-success">Continuar compra</a>
      </div>
    </div>
  </div>

  <!-- Clase PedidoDetalle -->
  <div class="mt-4">
    <h6>Clase <code>PedidoDetalle</code> (mock)</h6>
<pre class="bg-white p-3 border rounded"><code>PedidoDetalle {
  idDetalle: Integer
  idPedido: Integer
  idProducto: Integer
  nombreProducto: String
  cantidad: Integer
  precioUnitario: Float
  subtotal: Float
}</code></pre>
  </div>
</div>

<script>
  // Cat√°logo base (para traducir id->datos cuando llega ?add)
  const CATALOGO = [
    {id:1, nombre:'Tacos al Pastor', precio:4990},
    {id:2, nombre:'Burrito Especial', precio:6490},
    {id:3, nombre:'Combo Fiesta', precio:10990},
    {id:4, nombre:'Tacos Supremos', precio:5990}
  ];

  // Carrito (localStorage)
  const KEY_CART = 'carrito_b11';
  function loadCart(){ return JSON.parse(localStorage.getItem(KEY_CART) || '[]'); }
  function saveCart(c){ localStorage.setItem(KEY_CART, JSON.stringify(c)); }

  // Auto-agregar desde ?add=ID&qty=N
  (function addFromParams(){
    const sp = new URLSearchParams(location.search);
    const addId = parseInt(sp.get('add') || '0', 10);
    const qty = Math.max(1, parseInt(sp.get('qty') || '1', 10));
    if (!addId) return;

    const prod = CATALOGO.find(p => p.id === addId);
    if (!prod) return;

    let cart = loadCart();
    const found = cart.find(d => d.idProducto === addId);
    if (found) {
      found.cantidad += qty;
      found.subtotal = found.cantidad * found.precioUnitario;
    } else {
      cart.push({
        idDetalle: Date.now(),
        idPedido: 1,
        idProducto: addId,
        nombreProducto: prod.nombre,
        cantidad: qty,
        precioUnitario: prod.precio,
        subtotal: qty * prod.precio
      });
    }
    saveCart(cart);
    // Limpiar query para no duplicar en refresh
    if (history.replaceState) history.replaceState({}, document.title, location.pathname);
  })();

  // Render del carrito
  const tbody = document.getElementById('tbodyCarrito');
  const totalCell = document.getElementById('totalCell');

  function renderCart(){
    const cart = loadCart();
    if (cart.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tu pedido est√° vac√≠o.</td></tr>`;
      totalCell.textContent = '$0';
      return;
    }
    tbody.innerHTML = cart.map(d => `
      <tr data-id="${d.idProducto}">
        <td>${d.nombreProducto}</td>
        <td class="text-center" style="width:160px">
          <div class="input-group input-group-sm mx-auto" style="max-width:140px">
            <button class="btn btn-outline-secondary btn-minus-detail">‚àí</button>
            <input type="number" class="form-control text-center qty-detail" value="${d.cantidad}" min="1">
            <button class="btn btn-outline-secondary btn-plus-detail">+</button>
          </div>
        </td>
        <td class="text-end">$${d.precioUnitario}</td>
        <td class="text-end item-subtotal">$${d.subtotal}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger btn-del">Quitar</button></td>
      </tr>
    `).join('');
    const total = cart.reduce((acc, d) => acc + d.subtotal, 0);
    totalCell.textContent = `$${total}`;
  }

  // Eventos en el detalle
  tbody.addEventListener('click', (e) => {
    const tr = e.target.closest('tr[data-id]'); if(!tr) return;
    const id = parseInt(tr.dataset.id,10);
    let cart = loadCart();
    const item = cart.find(d => d.idProducto === id); if(!item) return;

    if (e.target.classList.contains('btn-minus-detail')) item.cantidad = Math.max(1, item.cantidad-1);
    if (e.target.classList.contains('btn-plus-detail'))  item.cantidad += 1;
    if (e.target.classList.contains('btn-del')) {
      cart = cart.filter(d => d.idProducto !== id);
      saveCart(cart); renderCart(); return;
    }
    item.subtotal = item.cantidad * item.precioUnitario;
    saveCart(cart); renderCart();
  });

  tbody.addEventListener('change', (e)=>{
    const tr = e.target.closest('tr[data-id]');
    if (!tr || !e.target.classList.contains('qty-detail')) return;
    const id = parseInt(tr.dataset.id,10);
    const qty = Math.max(1, parseInt(e.target.value||1,10));
    const cart = loadCart();
    const item = cart.find(d => d.idProducto === id);
    if (!item) return;
    item.cantidad = qty;
    item.subtotal = qty * item.precioUnitario;
    saveCart(cart); renderCart();
  });

  // Init
  renderCart();
</script>
</body>
</html>
