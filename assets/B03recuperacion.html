<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B03 ‚Äì Recuperaci√≥n</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tu CSS (opcional) -->
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Base (ajusta si tu carpeta cambia) -->
  <base href="/FrontendSkeleton_elMariachi-1/">
</head>
<body class="bg-light">

  <!-- NAVBAR consistente -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="index.html">üåÆ El Mariachi</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="B02login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link active" href="B03_recuperacion.html">Recuperaci√≥n</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <!-- F1: Gherkin (3 escenarios) -->
    <section class="mb-4">
      <h2 class="h5 text-success fw-bold">Escenarios (Gherkin)</h2>
      <pre class="bg-white border rounded p-3 small mb-0">
Feature: Recuperaci√≥n de contrase√±a
  Scenario: Solicitud v√°lida
    Given que estoy en la p√°gina de recuperaci√≥n
    And ingreso un correo registrado
    When presiono "Enviar"
    Then veo un mensaje de √©xito indicando que se envi√≥ el enlace

  Scenario: Correo no registrado
    Given que estoy en la p√°gina de recuperaci√≥n
    And ingreso un correo que no existe
    When presiono "Enviar"
    Then veo un mensaje de error indicando que el correo no est√° registrado

  Scenario: Enlace caducado
    Given que accedo desde un enlace de recuperaci√≥n
    And el token est√° expirado
    Then veo un mensaje de error y la opci√≥n "Reintentar"
      </pre>
    </section>

    <!-- F2: Form "Olvid√© mi contrase√±a" -->
    <section class="bg-white border rounded shadow-sm p-4" style="max-width: 560px;">
      <h1 class="h4 mb-3">Olvid√© mi contrase√±a</h1>
      <form id="recoverForm" novalidate>
        <div class="mb-3">
          <label for="recoverEmail" class="form-label">Correo electr√≥nico</label>
          <input type="email" class="form-control" id="recoverEmail" placeholder="ana@example.com" required>
          <div class="invalid-feedback">Ingresa un correo v√°lido.</div>
        </div>
        <button type="submit" class="btn btn-success">Enviar</button>
        <a href="B02login.html" class="btn btn-outline-secondary ms-2">Volver al Login</a>
      </form>
    </section>

    <!-- F3: Vista con enlace de recuperaci√≥n (representativa) -->
    <section class="mt-4">
      <div class="alert alert-info mb-0">
        <strong>Ejemplo de enlace:</strong> 
        <code>https://mariachi.cl/reset?token=ABC123&email=ana%40example.com</code>
      </div>
    </section>
  </main>

  <!-- F4: Modal √©xito -->
  <div class="modal fade" id="okModal" tabindex="-1" aria-labelledby="okModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="okModalLabel">¬°Solicitud enviada!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          Te enviamos un enlace de recuperaci√≥n a <span id="okEmail" class="fw-bold"></span>. Revisa tu bandeja y spam.
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- F5: Modal error -->
  <div class="modal fade" id="errModal" tabindex="-1" aria-labelledby="errModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="errModalLabel">No pudimos procesar tu solicitud</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="errMsg">
          Token inv√°lido o correo no registrado. Intenta nuevamente.
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Reintentar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- F6: Clase "Recuperaci√≥nDeContrase√±a" + l√≥gica demo -->
  <script>
    class RecuperacionDeContrasena {
      constructor(correoUsuario) {
        this.correoUsuario = correoUsuario;
        this.token = Math.random().toString(36).slice(2);
        this.fechaExpiracion = new Date(Date.now() + 1000 * 60 * 15); // 15 min
        this.valido = true;
      }
      estaVigente() {
        return this.valido && new Date() < this.fechaExpiracion;
      }
      invalidar() { this.valido = false; }
    }

    // Mock de usuarios existentes
    const EXISTENTES = ['ana@example.com', 'admin@site.com'];

    const form = document.getElementById('recoverForm');
    const emailInput = document.getElementById('recoverEmail');

    const okModal = new bootstrap.Modal(document.getElementById('okModal'));
    const errModal = new bootstrap.Modal(document.getElementById('errModal'));

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Validaci√≥n HTML5
      if (!emailInput.checkValidity()) {
        emailInput.classList.add('is-invalid');
        return;
      } else {
        emailInput.classList.remove('is-invalid');
      }

      const email = emailInput.value.trim().toLowerCase();

      // Simulaci√≥n: si el correo existe -> √©xito; si no -> error
      if (EXISTENTES.includes(email)) {
        const flow = new RecuperacionDeContrasena(email);
        if (flow.estaVigente()) {
          document.getElementById('okEmail').textContent = email;
          okModal.show();
          form.reset();
        } else {
          document.getElementById('errMsg').textContent = 'El enlace ha caducado. Solicita uno nuevo.';
          errModal.show();
        }
      } else {
        document.getElementById('errMsg').textContent = 'El correo ingresado no est√° registrado.';
        errModal.show();
      }
    });
  </script>
</body>
</html>
